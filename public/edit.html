<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Gallery — PhotoTransfer</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafaf9;
      color: #1a1a1a;
      min-height: 100vh;
    }
    header {
      background: #fff;
      border-bottom: 1px solid #e8e6e3;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { font-size: 1.1rem; font-weight: 700; color: #111; letter-spacing: -0.01em; }
    .header-actions { display: flex; align-items: center; gap: 0.6rem; }
    .back-btn {
      background: none;
      border: 1px solid #ddd;
      color: #999;
      padding: 0.35rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.82rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover { border-color: #bbb; color: #444; }

    main { max-width: 960px; margin: 0 auto; padding: 2rem; }
    h2 { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.3rem; letter-spacing: -0.02em; color: #111; }
    .gallery-name { color: #aaa; margin-bottom: 1.5rem; font-size: 0.88rem; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .toolbar-info { color: #999; font-size: 0.85rem; }
    .btn-save {
      background: #1a1a1a;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.55rem 1.2rem;
      font-size: 0.88rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-save:hover { background: #333; }
    .btn-save:disabled { background: #ccc; cursor: not-allowed; }
    .btn-save.saved { background: #4caf50; }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 0.75rem;
    }

    .image-card {
      background: #fff;
      border: 1px solid #e8e6e3;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      cursor: grab;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s, opacity 0.15s;
      user-select: none;
      -webkit-user-select: none;
    }
    .image-card:hover { border-color: #ccc; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .image-card:active { cursor: grabbing; }
    .image-card.dragging {
      opacity: 0.4;
      transform: scale(0.95);
      border-color: #aaa;
    }
    .image-card.drag-over {
      border-color: #1a1a1a;
      box-shadow: 0 0 0 2px #1a1a1a;
    }

    .image-card img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
      pointer-events: none;
    }

    .image-card-info {
      padding: 0.5rem 0.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.3rem;
    }
    .image-card-name {
      font-size: 0.72rem;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      min-width: 0;
    }
    .image-card-order {
      font-size: 0.68rem;
      color: #ccc;
      font-weight: 600;
      flex-shrink: 0;
    }

    .btn-delete-img {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      width: 1.6rem;
      height: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-size: 0.85rem;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s, background 0.15s;
      z-index: 2;
    }
    .image-card:hover .btn-delete-img { opacity: 1; }
    .btn-delete-img:hover { background: #e53935; }

    .empty-state {
      text-align: center;
      color: #ccc;
      padding: 4rem 2rem;
    }
    .empty-state p { font-size: 0.95rem; }

    #loadingState { text-align: center; color: #ccc; padding: 3rem; font-size: 0.9rem; }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 0.65rem 1.1rem;
      color: #fff;
      font-size: 0.85rem;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.25s;
      z-index: 1000;
    }
    .toast.show { transform: translateY(0); opacity: 1; }

    /* Touch-friendly: bigger hit areas on mobile */
    @media (max-width: 600px) {
      main { padding: 1rem; }
      .image-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
      .btn-delete-img { opacity: 1; width: 1.8rem; height: 1.8rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">PhotoTransfer</div>
    <div class="header-actions">
      <a class="back-btn" href="/dashboard">Dashboard</a>
    </div>
  </header>

  <main>
    <h2>Edit Gallery</h2>
    <div class="gallery-name" id="galleryName">Loading...</div>

    <div class="toolbar" id="toolbar" style="display:none">
      <div class="toolbar-info" id="imageCount"></div>
      <button class="btn-save" id="saveBtn" onclick="saveOrder()" disabled>Save order</button>
    </div>

    <div id="loadingState">Loading...</div>
    <div class="image-grid" id="imageGrid" style="display:none"></div>
    <div class="empty-state" id="emptyState" style="display:none">
      <p>No images in this gallery yet.</p>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const token = localStorage.getItem('pt_token');
    if (!token) window.location.href = '/login';

    const galleryId = window.location.pathname.split('/').pop();
    let images = [];
    let orderChanged = false;
    let dragSrcIndex = null;

    function authHeaders(json) {
      const h = { 'Authorization': 'Bearer ' + token };
      if (json) h['Content-Type'] = 'application/json';
      return h;
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    function escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    async function loadGallery() {
      try {
        const res = await fetch('/api/galleries/' + galleryId, {
          headers: authHeaders(),
        });
        if (res.status === 401) { window.location.href = '/login'; return; }
        if (!res.ok) { document.getElementById('galleryName').textContent = 'Gallery not found'; return; }
        const data = await res.json();
        document.getElementById('galleryName').textContent = data.title;
        document.title = `Edit — ${data.title}`;
        images = (data.images || []).sort((a, b) => {
          if (a.sort_order !== b.sort_order) return a.sort_order - b.sort_order;
          return new Date(a.uploaded_at) - new Date(b.uploaded_at);
        });
        render();
      } catch (err) {
        document.getElementById('loadingState').textContent = 'Failed to load gallery.';
      }
    }

    function render() {
      const grid = document.getElementById('imageGrid');
      const empty = document.getElementById('emptyState');
      const toolbar = document.getElementById('toolbar');
      document.getElementById('loadingState').style.display = 'none';

      if (!images.length) {
        empty.style.display = 'block';
        grid.style.display = 'none';
        toolbar.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      grid.style.display = 'grid';
      toolbar.style.display = 'flex';
      document.getElementById('imageCount').textContent = images.length + ' image' + (images.length !== 1 ? 's' : '') + ' — drag to reorder';

      grid.innerHTML = '';
      images.forEach((img, idx) => {
        const card = document.createElement('div');
        card.className = 'image-card';
        card.draggable = true;
        card.dataset.index = idx;

        // Use thumb_key signed URL or placeholder
        const thumbSrc = img.thumbUrl || '';

        card.innerHTML = `
          <button class="btn-delete-img" onclick="deleteImage(${img.id}, event)" title="Delete image">&times;</button>
          <img src="${escHtml(thumbSrc)}" alt="${escHtml(img.filename)}" loading="lazy">
          <div class="image-card-info">
            <div class="image-card-name" title="${escHtml(img.filename)}">${escHtml(img.filename)}</div>
            <div class="image-card-order">#${idx + 1}</div>
          </div>
        `;

        // Drag events
        card.addEventListener('dragstart', onDragStart);
        card.addEventListener('dragend', onDragEnd);
        card.addEventListener('dragover', onDragOver);
        card.addEventListener('dragenter', onDragEnter);
        card.addEventListener('dragleave', onDragLeave);
        card.addEventListener('drop', onDrop);

        // Touch events for mobile drag
        card.addEventListener('touchstart', onTouchStart, { passive: false });
        card.addEventListener('touchmove', onTouchMove, { passive: false });
        card.addEventListener('touchend', onTouchEnd);

        grid.appendChild(card);
      });
    }

    // --- Desktop drag & drop ---
    function onDragStart(e) {
      dragSrcIndex = parseInt(this.dataset.index);
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', dragSrcIndex);
    }

    function onDragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('.image-card').forEach(c => c.classList.remove('drag-over'));
    }

    function onDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function onDragEnter(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    }

    function onDragLeave(e) {
      this.classList.remove('drag-over');
    }

    function onDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      const targetIndex = parseInt(this.dataset.index);
      if (dragSrcIndex === null || dragSrcIndex === targetIndex) return;
      reorderImages(dragSrcIndex, targetIndex);
      dragSrcIndex = null;
    }

    // --- Touch drag & drop (mobile) ---
    let touchDragIndex = null;
    let touchClone = null;
    let touchStartX = 0, touchStartY = 0;
    let touchMoved = false;

    function onTouchStart(e) {
      touchDragIndex = parseInt(this.dataset.index);
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      touchMoved = false;
    }

    function onTouchMove(e) {
      if (touchDragIndex === null) return;
      const dx = e.touches[0].clientX - touchStartX;
      const dy = e.touches[0].clientY - touchStartY;
      if (!touchMoved && Math.abs(dx) < 10 && Math.abs(dy) < 10) return;
      touchMoved = true;
      e.preventDefault();

      const cards = document.querySelectorAll('.image-card');
      cards[touchDragIndex].classList.add('dragging');

      // Find which card the touch is over
      const touch = e.touches[0];
      cards.forEach(c => c.classList.remove('drag-over'));
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (el) {
        const card = el.closest('.image-card');
        if (card && parseInt(card.dataset.index) !== touchDragIndex) {
          card.classList.add('drag-over');
        }
      }
    }

    function onTouchEnd(e) {
      if (touchDragIndex === null) return;
      const cards = document.querySelectorAll('.image-card');
      cards[touchDragIndex].classList.remove('dragging');

      if (!touchMoved) { touchDragIndex = null; return; }

      // Find target
      const touch = e.changedTouches[0];
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      cards.forEach(c => c.classList.remove('drag-over'));

      if (el) {
        const card = el.closest('.image-card');
        if (card) {
          const targetIndex = parseInt(card.dataset.index);
          if (targetIndex !== touchDragIndex) {
            reorderImages(touchDragIndex, targetIndex);
          }
        }
      }
      touchDragIndex = null;
    }

    function reorderImages(fromIndex, toIndex) {
      const [moved] = images.splice(fromIndex, 1);
      images.splice(toIndex, 0, moved);
      orderChanged = true;
      document.getElementById('saveBtn').disabled = false;
      document.getElementById('saveBtn').classList.remove('saved');
      document.getElementById('saveBtn').textContent = 'Save order';
      render();
    }

    async function saveOrder() {
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const imageIds = images.map(img => img.id);
        const res = await fetch('/api/images/reorder', {
          method: 'PUT',
          headers: authHeaders(true),
          body: JSON.stringify({ galleryId: parseInt(galleryId), imageIds }),
        });
        if (!res.ok) throw new Error((await res.json()).error);
        orderChanged = false;
        btn.textContent = 'Saved';
        btn.classList.add('saved');
        showToast('Order saved');
        setTimeout(() => {
          btn.textContent = 'Save order';
          btn.classList.remove('saved');
        }, 2000);
      } catch (err) {
        alert('Failed to save order: ' + err.message);
        btn.textContent = 'Save order';
      } finally {
        btn.disabled = false;
      }
    }

    async function deleteImage(imageId, e) {
      e.stopPropagation();
      if (!confirm('Delete this image? This cannot be undone.')) return;

      try {
        const res = await fetch('/api/images/' + imageId, {
          method: 'DELETE',
          headers: authHeaders(),
        });
        if (!res.ok) throw new Error((await res.json()).error);
        images = images.filter(img => img.id !== imageId);
        render();
        showToast('Image deleted');
      } catch (err) {
        alert('Failed to delete: ' + err.message);
      }
    }

    loadGallery();
  </script>
</body>
</html>
